<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Strike Latino 2 - Tabla & Juegos</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
</head>
<body>
  <div class="container">
    <h1>‚öæ Strike Latino 2</h1>
    <p class="subtitle">Tabla de posiciones y juegos del d√≠a</p>

    <div id="loading">
      <p id="loading-text">Cargando datos, por favor espera‚Ä¶</p>
    </div>

    <div id="error" class="hidden"></div>
    <div id="last-updated-text" class="last-updated hidden"></div>

    <section id="standings-section" class="hidden">
      <h2>üèÜ Tabla de posiciones</h2>
      <div class="table-wrapper">
        <table id="standings-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Equipo</th>
              <th>Jugador</th>
              <th>Prog</th>
              <th>JJ</th>
              <th>W</th>
              <th>L</th>
              <th>Por jugar</th>
              <th>Pts</th>
            </tr>
          </thead>
          <tbody id="standings-body"></tbody>
        </table>
      </div>
    </section>

    <section id="games-today-section" class="hidden">
      <h2>üìÖ Juegos jugados hoy</h2>
      <ul id="games-today-list" class="games-list"></ul>
    </section>
  </div>

  <script>
    const loadingBox = document.getElementById("loading");
    const errorBox = document.getElementById("error");
    const lastUpdated = document.getElementById("last-updated-text");

    const standingsSection = document.getElementById("standings-section");
    const standingsBody = document.getElementById("standings-body");

    const gamesTodaySection = document.getElementById("games-today-section");
    const gamesTodayList = document.getElementById("games-today-list");

    function show(el){ el.classList.remove("hidden"); }
    function hide(el){ el.classList.add("hidden"); }

    async function loadData() {
      hide(errorBox);
      show(loadingBox);
      try {
        const res = await fetch("/api/full", { cache: "no-store" });
        if (!res.ok) {
          const j = await res.json().catch(()=>({error:""}));
          throw new Error(j.error || `HTTP ${res.status}`);
        }
        const data = await res.json();

        // Marca de tiempo
        if (data.last_updated) {
          lastUpdated.textContent = `√öltima actualizaci√≥n: ${data.last_updated}`;
          show(lastUpdated);
        }

        // Standings
        standingsBody.innerHTML = "";
        (data.standings || []).forEach((row, idx) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${idx + 1}</td>
            <td>${row.team}</td>
            <td><span class="tag">${row.user}</span></td>
            <td class="num">${row.scheduled}</td>
            <td class="num">${row.played}</td>
            <td class="num ok">${row.wins}</td>
            <td class="num bad">${row.losses}</td>
            <td class="num">${row.remaining}</td>
            <td class="num">${row.points}</td>
          `;
          standingsBody.appendChild(tr);
        });
        show(standingsSection);

        // Juegos de hoy
 
  const loadingBox = document.getElementById("loading");
  const errorBox = document.getElementById("error");
  const lastUpdated = document.getElementById("last-updated-text");

  const standingsSection = document.getElementById("standings-section");
  const standingsBody = document.getElementById("standings-body");

  const gamesTodaySection = document.getElementById("games-today-section");
  const gamesTodayList = document.getElementById("games-today-list");

  function show(el){ el.classList.remove("hidden"); }
  function hide(el){ el.classList.add("hidden"); }

  function parseGameString(s){
    // Normaliza espacios y separa: "Home X - Away Y - fecha - hora (Chile)"
    const norm = s.replace(/\s+/g,' ').trim();
    const parts = norm.split(' - ');
    // Esperamos al menos 4 partes: ["Yankees 2", "Mariners 0", "07-09-2025", "11:47 am (hora Chile)"]
    if (parts.length >= 4) {
      const [homePart, awayPart, datePart, timePart] = parts;
      const splitLast = (txt) => {
        const i = txt.lastIndexOf(' ');
        if (i === -1) return { name: txt, score: '' };
        return { name: txt.slice(0,i), score: txt.slice(i+1) };
        };
      const h = splitLast(homePart);
      const a = splitLast(awayPart);
      return {
        home_team: h.name,
        home_score: h.score,
        away_team: a.name,
        away_score: a.score,
        ended_at_local: `${datePart} - ${timePart}`
      };
    }
    // Si no se puede parsear, lo devolvemos como texto crudo
    return { raw: s };
  }

  async function loadData() {
    hide(errorBox);
    show(loadingBox);
    try {
      const res = await fetch("/api/full", { cache: "no-store" });
      if (!res.ok) {
        const j = await res.json().catch(()=>({error:""}));
        throw new Error(j.error || `HTTP ${res.status}`);
      }
      const data = await res.json();

      // √öltima actualizaci√≥n
      if (data.last_updated) {
        lastUpdated.textContent = `√öltima actualizaci√≥n: ${data.last_updated}`;
        show(lastUpdated);
      }

      // Tabla
      standingsBody.innerHTML = "";
      (data.standings || []).forEach((row, idx) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${idx + 1}</td>
          <td>${row.team}</td>
          <td><span class="tag">${row.user}</span></td>
          <td class="num">${row.scheduled}</td>
          <td class="num">${row.played}</td>
          <td class="num ok">${row.wins}</td>
          <td class="num bad">${row.losses}</td>
          <td class="num">${row.remaining}</td>
          <td class="num">${row.points}</td>
        `;
        standingsBody.appendChild(tr);
      });
      show(standingsSection);

      // Juegos de hoy (acepta string u objeto)
      gamesTodayList.innerHTML = "";
      const games = data.games_today || [];
      if (games.length === 0) {
        gamesTodayList.innerHTML = `<li class="muted">No hay juegos finalizados hoy.</li>`;
      } else {
        games.forEach(g => {
          let obj = g;
          if (typeof g === 'string') obj = parseGameString(g);

          const li = document.createElement("li");
          if (obj.raw) {
            // fallback: mostrar el string tal cual si no se pudo parsear
            li.textContent = obj.raw;
          } else {
            li.innerHTML = `
              <div><strong>${obj.home_team}</strong> ${obj.home_score} - ${obj.away_score} <strong>${obj.away_team}</strong></div>
              <div class="pill">${obj.ended_at_local}</div>
            `;
          }
          gamesTodayList.appendChild(li);
        });
      }
      show(gamesTodaySection);

    } catch (err) {
      errorBox.textContent = "No se pudieron cargar los datos: " + err.message;
      show(errorBox);
    } finally {
      hide(loadingBox);
    }
  }

  loadData();
</script>

</body>
</html>
